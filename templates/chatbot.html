{% extends 'base.html' %}

{% block styles %}
<style>
  /* Base styling for body and html */
  body, html {
    height: 100%;
    margin: 0;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    background: #121212;
    color: #e0e0e0;
    scroll-behavior: smooth;
  }
  
  /* Chat container with grainy background */
  .chat-container {
    height: 100%;
    display: flex;
    flex-direction: column;
    padding: inherit;
    position: relative;
    background: linear-gradient(145deg, #1a1a1a 25%, #2a2a2a 75%);
    overflow: hidden;
    z-index: 0;
  }
  
  @keyframes backgroundShift {
    0% { background-position: 0 0; }
    100% { background-position: 40px 40px; }
  }
  
  /* Card styling */
  .card {
    background-color: #1a1a1a;
    border-radius: 0px;
    overflow: hidden;
    flex-grow: 1;
    z-index: 1;
    animation: cardAppear 0.5s ease-out;
  }
  
  @keyframes cardAppear {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  /* Messages box with inner padding and scroll */
  .messages-box {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    background-color: #212121;
    border-top: 1px solid #333;
    flex-grow: 1;
    scroll-behavior: smooth;
  }
  
  /* Remove default list styles */
  .messages-list {
    padding-left: 0;
    margin: 0;
    width: 100%;
    max-width: 800px;
  }
  
  /* Chat boxes */
  .chat-box {
    background-color: #2a2a2a;
    border-radius: 5px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    width: 200%;
    max-width: 750px;
    animation: messageAppear 0.3s ease-out;
    transition: transform 0.3s ease;
  }
  
  .chat-box:hover {
    transform: scale(1.02);
  }
  
  .chat-box.sent {
    align-self: flex-end;
    background-color: #333333;
  }
  
  .chat-box.received {
    align-self: flex-start;
    background-color: #2a2a2a;
  }
  
  @keyframes messageAppear {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  .chat-box-header {
    font-weight: bold;
    margin-bottom: 10px;
    color: #bbb;
  }
  
  .chat-box-content {
    color: #e0e0e0;
    white-space: pre-wrap;
    word-wrap: break-word;
  }
  
  /* Message form container styling */
  .message-form {
    display: flex;
    padding: 10px;
    background-color: #1a1a1a;
    border-radius: 25px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    z-index: 1;
    animation: formAppear 0.5s ease-out;
    overflow: hidden;
  }
  
  @keyframes formAppear {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  /* Message input field styling */
  .message-input {
    flex: 1;
    border: 1px solid #333;
    padding: 10px 15px;
    border-radius: 20px 0 0 20px;
    background-color: #121212;
    color: #e0e0e0;
    transition: all 0.3s ease;
  }
  
  .message-input:focus {
    outline: none;
    box-shadow: 0 0 0 2px #4CAF50;
  }
  
  /* Send button styling */
  .btn-send {
    border-radius: 0 20px 20px 0;
    background-color: #616161;
    color: white;
    border: none;
    padding: 5px 20px;
    font-weight: bold;
    transition: all 0.3s ease;
  }
  
  /* Send button hover effect */
  .btn-send:hover {
    background-color: #45a049;
    transform: scale(1.05);
  }
  
  /* Typing indicator */
  .typing-indicator {
    display: none;
    padding: 10px;
    font-size: 0.8rem;
    color: #888;
  }
  
  .typing-indicator::after {
    content: '...';
    animation: typing 1.5s infinite;
  }
  
  @keyframes typing {
    0% { content: '.'; }
    33% { content: '..'; }
    66% { content: '...'; }
  }
  
  /* Action buttons */
  .action-buttons {
    display: flex;
    justify-content: flex-end;
    padding: 10px;
    background-color: #1a1a1a;
  }
  
  .action-button {
    background-color: #424242;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }
  
  .action-button:hover {
    background-color: #616161;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
  }
  
  /* Scroll to bottom button */
  .scroll-to-bottom {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background-color: #424242;
    color: white;
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    font-size: 20px;
    display: none;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    transition: background-color 0.3s ease;
    z-index: 1000;
  }
  
  .scroll-to-bottom:hover {
    background-color: #616161;
  }
  
</style>
{% endblock %}

{% block content %}
<div class="chat-container">
  <div class="card flex-grow-1">
    <div class="card-header">
      <h2 class="chat-title">Nivan</h2>
    </div>
    <div class="card-body messages-box">
      <ul class="list-unstyled messages-list" aria-live="polite">
        <li class="chat-box received">
          <div class="chat-box-header">Nivan</div>
          <div class="chat-box-content">
            Namaste! How can i assist you today?
          </div>
        </li>
      </ul>
      <div class="typing-indicator" aria-live="polite">Nivan is typing</div>
      <div id="imageContainer" class="image-container" style="display: none;">
        <img id="uploadedImage" class="uploaded-image" alt="Uploaded image">
        <button id="removeImageBtn" class="remove-image-btn">&times;</button>
      </div>
    </div>
    <div class="action-buttons">
      <button class="action-button" id="clearChat">Clear Chat</button>
    </div>
    <form class="message-form">
      {% csrf_token %}
      <div class="input-group">
        <div class="image-upload-container">
          <button type="button" class="btn btn-secondary" id="imageUploadButton">
            <i class="fas fa-image"></i>
          </button>
          <input type="file" id="imageUpload" accept="image/*" style="display: none;">
        </div>
        <input type="text" class="form-control message-input" placeholder="Type your message..." aria-label="Type your message">
        <div class="input-group-append">
          <button type="submit" class="btn btn-primary btn-send">Send</button>
        </div>
      </div>
    </form>
  </div>
</div>
<button class="scroll-to-bottom" aria-label="Scroll to bottom">↓</button>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const messagesList = document.querySelector('.messages-list');
    const messageForm = document.querySelector('.message-form');
    const messageInput = document.querySelector('.message-input');
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const typingIndicator = document.querySelector('.typing-indicator');
    const clearChatButton = document.getElementById('clearChat');
    const scrollToBottomButton = document.querySelector('.scroll-to-bottom');
    const imageUploadButton = document.getElementById('imageUploadButton');
    const imageUpload = document.getElementById('imageUpload');
    const imageContainer = document.getElementById('imageContainer');
    const uploadedImage = document.getElementById('uploadedImage');
    const removeImageBtn = document.getElementById('removeImageBtn');
  
    let chatHistory = [];
    let currentImage = null;
  
    const createMessageElement = (message, sender, isReceived, audioUrl = null) => {
      const messageItem = document.createElement('li');
      messageItem.classList.add('chat-box', isReceived ? 'received' : 'sent');
      messageItem.innerHTML = `
        <div class="chat-box-header">${sender}</div>
        <div class="chat-box-content">
          ${formatMessage(message)}
          ${audioUrl ? `
            <div class="audio-player">
              <audio controls>
                <source src="${audioUrl}" type="audio/mpeg">
                Your browser does not support the audio element.
              </audio>
            </div>
          ` : ''}
        </div>`;
  
      return messageItem;
    };
  
    const formatMessage = (message) => {
      const paragraphs = message.split('\n\n');
      const formattedParagraphs = paragraphs.map(paragraph => {
        if (paragraph.includes('\n- ')) {
          const listItems = paragraph.split('\n- ');
          const formattedList = listItems.map((item, index) => 
            index === 0 ? item : `• ${item}`
          ).join('<br>');
          return formattedList;
        }
        return paragraph;
      });
      return formattedParagraphs.join('<br><br>');
    };
  
    const sendMessage = async (message, image = null) => {
      try {
        typingIndicator.style.display = 'block';
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', csrfToken);
        formData.append('message', message);
        if (image) {
          formData.append('image', image);
        }
        const response = await fetch('', {
          method: 'POST',
          body: formData
        });
        const data = await response.json();
        typingIndicator.style.display = 'none';
        return data;
      } catch (error) {
        console.error('Error sending message:', error);
        typingIndicator.style.display = 'none';
        return null;
      }
    };
  
    messageForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const message = messageInput.value.trim();
      if (message.length === 0 && !currentImage) return;
  
      const userMessage = createMessageElement(message, 'You', false);
      messagesList.appendChild(userMessage);
      messageInput.value = '';
  
      let response;
      if (currentImage) {
        response = await sendMessage(message, currentImage);
      } else {
        response = await sendMessage(message);
      }
  
      if (response) {
        setTimeout(() => {
          const aiMessage = createMessageElement(response.response, 'Nivan', true, response.audio_url);
          messagesList.appendChild(aiMessage);
          scrollToBottom();
        }, 500);
      }
  
      chatHistory.push({ human: message, AI: response.response });
      scrollToBottom();
    });
  
    clearChatButton.addEventListener('click', () => {
      messagesList.innerHTML = '';
      chatHistory = [];
      const initialMessage = createMessageElement('Chat cleared. How can I assist you?', 'Nivan', true);
      messagesList.appendChild(initialMessage);
      scrollToBottom();
      removeImage();
    });
  
    const scrollToBottom = () => {
      messagesList.scrollTop = messagesList.scrollHeight;
      scrollToBottomButton.style.display = 'none';
    };
  
    messagesList.addEventListener('scroll', () => {
      if (messagesList.scrollTop + messagesList.clientHeight < messagesList.scrollHeight - 100) {
        scrollToBottomButton.style.display = 'flex';
      } else {
        scrollToBottomButton.style.display = 'none';
      }
    });
  
    scrollToBottomButton.addEventListener('click', scrollToBottom);
  
    imageUploadButton.addEventListener('click', () => {
      imageUpload.click();
    });
  
    imageUpload.addEventListener('change', (event) => {
      if (event.target.files.length > 0) {
        const file = event.target.files[0];
        const reader = new FileReader();
  
        reader.onload = (e) => {
          uploadedImage.src = e.target.result;
          imageContainer.style.display = 'block';
          currentImage = file;
        };
  
        reader.readAsDataURL(file);
        imageUploadButton.classList.add('file-selected');
      }
    });
  
    removeImageBtn.addEventListener('click', removeImage);
  
    function removeImage() {
      imageContainer.style.display = 'none';
      uploadedImage.src = '';
      imageUpload.value = '';
      currentImage = null;
      imageUploadButton.classList.remove('file-selected');
    }
  });
</script>
{% endblock %}
